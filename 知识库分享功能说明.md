# 知识库分享功能说明

## 功能概述

本次更新添加了完整的知识库分享功能，允许管理员将知识库分享给指定用户，实现知识库的协作和共享。

## 主要功能点

### 1. 管理员创建和管理共享知识库
- ✅ 管理员可以标记知识库为"可分享"状态
- ✅ 管理员可以将知识库分享给指定用户（支持多选）
- ✅ 设置分享权限（只读/可编辑）
- ✅ 查看知识库的所有分享记录
- ✅ 修改已分享用户的权限
- ✅ 撤销对特定用户的分享

### 2. 用户访问共享知识库
- ✅ 用户可以查看分享给自己的知识库
- ✅ 在对话中可以选择使用共享知识库
- ✅ 清晰区分自己的知识库和共享知识库

### 3. 权限控制
- **只读权限 (read_only)**：用户只能查看和使用知识库内容，不能修改
- **可编辑权限 (editable)**：用户可以查看、使用并修改知识库内容

## 数据库变更

### 新增表：knowledge_base_shares
```sql
CREATE TABLE knowledge_base_shares (
    id INTEGER PRIMARY KEY,
    knowledge_base_id INTEGER NOT NULL,  -- 知识库ID
    shared_by INTEGER NOT NULL,          -- 分享者ID（管理员）
    shared_to INTEGER NOT NULL,          -- 被分享者ID
    permission VARCHAR(20) DEFAULT 'read_only',  -- 权限类型
    created_at DATETIME,
    FOREIGN KEY (knowledge_base_id) REFERENCES knowledge_bases(id),
    FOREIGN KEY (shared_by) REFERENCES users(id),
    FOREIGN KEY (shared_to) REFERENCES users(id)
);
```

### 修改表：knowledge_bases
```sql
ALTER TABLE knowledge_bases
ADD COLUMN is_shareable BOOLEAN NOT NULL DEFAULT FALSE;
```

## API 接口

### 管理员接口

#### 1. 分享知识库
```http
POST /api/admin/knowledge-bases/share
Content-Type: application/json
Authorization: Bearer <admin_token>

{
  "kb_id": 1,
  "user_ids": [2, 3, 4],
  "permission": "read_only"  // 或 "editable"
}
```

#### 2. 取消分享
```http
POST /api/admin/knowledge-bases/unshare
Content-Type: application/json
Authorization: Bearer <admin_token>

{
  "kb_id": 1,
  "user_ids": [2, 3]
}
```

#### 3. 查看知识库分享列表
```http
GET /api/admin/knowledge-bases/{kb_id}/shares
Authorization: Bearer <admin_token>
```

#### 4. 更新分享权限
```http
PUT /api/admin/knowledge-bases/{kb_id}/shares/{user_id}
Content-Type: application/json
Authorization: Bearer <admin_token>

{
  "permission": "editable"
}
```

#### 5. 设置知识库可分享状态
```http
POST /api/admin/knowledge-bases/set-shareable
Content-Type: application/json
Authorization: Bearer <admin_token>

{
  "kb_id": 1,
  "is_shareable": true
}
```

### 用户接口

#### 获取分享给我的知识库
```http
GET /api/knowledge-bases/shared
Authorization: Bearer <user_token>
```

#### 获取所有知识库（包括自己的和共享的）
```http
GET /api/knowledge-bases
Authorization: Bearer <user_token>

响应格式：
{
  "own": [
    {
      "id": 1,
      "name": "我的知识库",
      "is_owner": true,
      "is_shareable": false,
      ...
    }
  ],
  "shared": [
    {
      "id": 2,
      "name": "共享知识库",
      "owner_username": "admin",
      "permission": "read_only",
      "is_shared": true,
      ...
    }
  ]
}
```

## 部署和迁移步骤

### 1. 运行数据库迁移
```bash
cd backend
python migrate_add_sharing.py
```

### 2. 重启后端服务
```bash
# 如果使用 Docker
docker-compose restart backend

# 或直接运行
python main.py
```

### 3. 测试功能

#### 测试步骤：
1. **管理员登录**
   - 使用管理员账户登录系统（默认: admin / Admin@2025）

2. **创建知识库**
   - 创建一个新的知识库并上传文档

3. **设置为可分享**
   - 将知识库标记为可分享状态

4. **分享给用户**
   - 选择要分享的用户
   - 设置权限（只读/可编辑）

5. **普通用户验证**
   - 使用普通用户账户登录
   - 查看共享知识库列表
   - 在对话中选择并使用共享知识库

## 前端集成说明

前端已经提供了以下API调用方法（在 `frontend/lib/api.ts` 中）：

```typescript
// 分享知识库
await shareKnowledgeBase(kbId, [userId1, userId2], 'read_only');

// 取消分享
await unshareKnowledgeBase(kbId, [userId1, userId2]);

// 获取分享列表
const shares = await getKnowledgeBaseShares(kbId);

// 更新权限
await updateSharePermission(kbId, userId, 'editable');

// 设置可分享状态
await setKnowledgeBaseShareable(kbId, true);

// 获取共享知识库
const sharedKbs = await getSharedKnowledgeBases();

// 获取所有知识库（包括自己的和共享的）
const allKbs = await getKnowledgeBases();
```

## 注意事项

1. **权限要求**
   - 只有管理员可以分享知识库
   - 只有管理员可以设置知识库的可分享状态

2. **数据安全**
   - 用户只能看到分享给自己的知识库
   - 只读权限的用户无法修改知识库内容

3. **数据一致性**
   - 删除知识库会自动删除所有相关的分享记录
   - 删除用户会自动清理相关的分享记录

4. **前端开发建议**
   - 在知识库列表中区分显示"我的知识库"和"共享知识库"
   - 对于共享知识库，显示所有者和权限信息
   - 在管理界面提供分享管理功能

## 下一步开发

虽然后端功能已经完整实现，但前端界面还需要开发以下部分：

1. **管理员界面**
   - [ ] 知识库分享管理页面
   - [ ] 用户选择器组件
   - [ ] 权限设置UI
   - [ ] 分享列表展示

2. **用户界面**
   - [ ] 共享知识库列表展示
   - [ ] 区分自有和共享知识库的UI
   - [ ] 在对话中选择知识库时显示共享标识

3. **优化功能**
   - [ ] 批量分享操作
   - [ ] 分享记录查询和筛选
   - [ ] 分享通知功能

## 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Next.js)                        │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐ │
│  │  知识库管理页面  │  │  分享管理界面   │  │  对话选择器    │ │
│  └────────────────┘  └────────────────┘  └────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │ API 调用
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    后端 (FastAPI)                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │           knowledge_base_service.py                     │ │
│  │  • share_knowledge_base()                              │ │
│  │  • unshare_knowledge_base()                            │ │
│  │  • get_shared_knowledge_bases()                        │ │
│  │  • get_kb_share_list()                                 │ │
│  │  • update_share_permission()                           │ │
│  │  • set_knowledge_base_shareable()                      │ │
│  └────────────────────────────────────────────────────────┘ │
│                          ▼                                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                   database.py                           │ │
│  │  • KnowledgeBase (新增 is_shareable 字段)               │ │
│  │  • KnowledgeBaseShare (新表)                           │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
                 ┌──────────┐
                 │ Database │
                 └──────────┘
```

## 支持和反馈

如有问题或建议，请联系开发团队。
