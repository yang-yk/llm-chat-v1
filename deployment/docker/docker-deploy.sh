#!/bin/bash

# LLM Chat System Docker ä¸€é”®éƒ¨ç½²è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: ./docker-deploy.sh

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "========================================="
echo "  LLM Chat System Docker ä¸€é”®éƒ¨ç½²"
echo "========================================="
echo ""

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ£€æŸ¥æ˜¯å¦åœ¨deployment/dockerç›®å½•
if [ ! -f "docker-compose.yml" ]; then
    echo -e "${RED}é”™è¯¯: è¯·åœ¨ deployment/docker ç›®å½•è¿è¡Œæ­¤è„šæœ¬${NC}"
    echo -e "${YELLOW}æç¤º: cd deployment/docker && ./docker-deploy.sh${NC}"
    exit 1
fi

# æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨
if [ ! -d "../../backend" ] || [ ! -d "../../frontend" ]; then
    echo -e "${RED}é”™è¯¯: æœªæ‰¾åˆ° backend æˆ– frontend ç›®å½•${NC}"
    echo -e "${YELLOW}è¯·ç¡®ä¿åœ¨æ­£ç¡®çš„é¡¹ç›®ç›®å½•ç»“æž„ä¸­è¿è¡Œæ­¤è„šæœ¬${NC}"
    exit 1
fi

# æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
echo -e "${BLUE}[1/8] æ£€æŸ¥çŽ¯å¢ƒ...${NC}"
if ! command -v docker &> /dev/null; then
    echo -e "${RED}é”™è¯¯: æœªæ£€æµ‹åˆ° Docker${NC}"
    echo "è¯·å…ˆå®‰è£… Docker: https://docs.docker.com/engine/install/"
    exit 1
fi

# æ£€æŸ¥ docker-compose æ˜¯å¦å®‰è£…ï¼ˆå…¼å®¹ V1 å’Œ V2ï¼‰
if command -v docker-compose &> /dev/null; then
    DOCKER_COMPOSE="docker-compose"
elif docker compose version &> /dev/null; then
    DOCKER_COMPOSE="docker compose"
else
    echo -e "${RED}é”™è¯¯: æœªæ£€æµ‹åˆ° docker-compose æˆ– docker compose${NC}"
    echo "è¯·å…ˆå®‰è£… Docker Compose: https://docs.docker.com/compose/install/"
    exit 1
fi

echo -e "${GREEN}âœ“ Docker çŽ¯å¢ƒæ£€æŸ¥é€šè¿‡${NC}"
echo ""

# è¯¢é—®é…ç½®ä¿¡æ¯
echo -e "${BLUE}[2/8] é…ç½®éƒ¨ç½²å‚æ•°...${NC}"
echo ""

read -p "æœåŠ¡å™¨ IP åœ°å€æˆ–åŸŸå [localhost]: " SERVER_HOST
SERVER_HOST=${SERVER_HOST:-localhost}

read -p "åŽç«¯æœåŠ¡ç«¯å£ [8000]: " BACKEND_PORT
BACKEND_PORT=${BACKEND_PORT:-8000}

read -p "å‰ç«¯æœåŠ¡ç«¯å£ [3000]: " FRONTEND_PORT
FRONTEND_PORT=${FRONTEND_PORT:-3000}

echo ""
echo -e "${YELLOW}æ˜¯å¦å¯ç”¨ Nginx åå‘ä»£ç†? (æŽ¨èç”Ÿäº§çŽ¯å¢ƒ) [y/N]:${NC}"
read -p "" ENABLE_NGINX
ENABLE_NGINX=${ENABLE_NGINX:-N}

NGINX_PORT=80
if [[ $ENABLE_NGINX =~ ^[Yy]$ ]]; then
    read -p "Nginx HTTP ç«¯å£ [80]: " NGINX_PORT
    NGINX_PORT=${NGINX_PORT:-80}
fi

echo ""
echo -e "${YELLOW}æ˜¯å¦ç”Ÿæˆæ–°çš„ JWT SECRET_KEY? (æŽ¨è) [Y/n]:${NC}"
read -p "" GENERATE_KEY
GENERATE_KEY=${GENERATE_KEY:-Y}

if [[ $GENERATE_KEY =~ ^[Yy]$ ]]; then
    SECRET_KEY=$(openssl rand -hex 32)
    echo -e "${GREEN}å·²ç”Ÿæˆæ–°çš„ SECRET_KEY${NC}"
else
    read -p "è¯·è¾“å…¥ SECRET_KEY: " SECRET_KEY
fi

echo ""
echo "========================================="
echo "é…ç½®ä¿¡æ¯ç¡®è®¤:"
echo "----------------------------------------"
echo "æœåŠ¡å™¨åœ°å€: $SERVER_HOST"
echo "åŽç«¯ç«¯å£: $BACKEND_PORT"
echo "å‰ç«¯ç«¯å£: $FRONTEND_PORT"
if [[ $ENABLE_NGINX =~ ^[Yy]$ ]]; then
    echo "Nginx ç«¯å£: $NGINX_PORT (å·²å¯ç”¨)"
else
    echo "Nginx: æœªå¯ç”¨"
fi
echo "SECRET_KEY: ${SECRET_KEY:0:10}..."
echo "========================================="
echo ""
read -p "ç¡®è®¤ä»¥ä¸Šé…ç½®æ­£ç¡®? [Y/n]: " CONFIRM
CONFIRM=${CONFIRM:-Y}

if [[ ! $CONFIRM =~ ^[Yy]$ ]]; then
    echo "éƒ¨ç½²å·²å–æ¶ˆ"
    exit 0
fi

# åˆ›å»ºå¿…è¦çš„ç›®å½•
echo ""
echo -e "${BLUE}[3/8] åˆ›å»ºå¿…è¦çš„ç›®å½•...${NC}"
mkdir -p logs
mkdir -p backend/logs
mkdir -p frontend/logs

# åˆ›å»º .env æ–‡ä»¶
echo -e "${BLUE}[4/8] ç”Ÿæˆ Docker çŽ¯å¢ƒå˜é‡é…ç½®...${NC}"
cat > .env <<EOF
# Docker Compose çŽ¯å¢ƒå˜é‡
# Generated by docker-deploy.sh on $(date)

# JWT é…ç½®
SECRET_KEY=$SECRET_KEY

# ç«¯å£é…ç½®
BACKEND_PORT=$BACKEND_PORT
FRONTEND_PORT=$FRONTEND_PORT
EOF

# åˆ›å»º docker-compose é…ç½®
cat > docker-compose.override.yml <<EOF
version: '3.8'

services:
  backend:
    ports:
      - "$BACKEND_PORT:8000"
    environment:
      - SECRET_KEY=$SECRET_KEY

  frontend:
    ports:
      - "$FRONTEND_PORT:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://$SERVER_HOST:$BACKEND_PORT
EOF

# å¦‚æžœå¯ç”¨ Nginxï¼Œæ·»åŠ é…ç½®
if [[ $ENABLE_NGINX =~ ^[Yy]$ ]]; then
    # æ›´æ–° Nginx é…ç½®
    mkdir -p nginx
    cat > nginx/nginx-docker.conf <<EOF
upstream backend_server {
    server backend:8000;
}

upstream frontend_server {
    server frontend:3000;
}

server {
    listen 80;
    server_name $SERVER_HOST;

    location / {
        proxy_pass http://frontend_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }

    location /api/ {
        proxy_pass http://backend_server/api/;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_read_timeout 300s;
    }

    location /auth/ {
        proxy_pass http://backend_server/auth/;
    }

    location /docs {
        proxy_pass http://backend_server/docs;
    }
}
EOF

    # æ·»åŠ  Nginx æœåŠ¡åˆ° docker-compose
    cat >> docker-compose.override.yml <<EOF

  nginx:
    image: nginx:alpine
    container_name: llm-chat-nginx
    ports:
      - "$NGINX_PORT:80"
    volumes:
      - ./nginx/nginx-docker.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
      - frontend
    restart: unless-stopped
    networks:
      - llm-chat-network
EOF

    echo -e "${GREEN}âœ“ Nginx åå‘ä»£ç†å·²é…ç½®${NC}"
fi

echo -e "${GREEN}âœ“ é…ç½®æ–‡ä»¶å·²åˆ›å»º${NC}"

# æž„å»º Docker é•œåƒ
echo ""
echo -e "${BLUE}[5/8] æž„å»º Docker é•œåƒ...${NC}"
$DOCKER_COMPOSE build

# å¯åŠ¨å®¹å™¨
echo ""
echo -e "${BLUE}[6/8] å¯åŠ¨ Docker å®¹å™¨...${NC}"
$DOCKER_COMPOSE up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo ""
echo -e "${BLUE}[7/8] ç­‰å¾…æœåŠ¡å¯åŠ¨...${NC}"
sleep 5

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo ""
echo -e "${BLUE}[8/8] æ£€æŸ¥æœåŠ¡çŠ¶æ€...${NC}"
$DOCKER_COMPOSE ps

# åˆ›å»ºç®¡ç†è„šæœ¬
echo ""
echo -e "${GREEN}åˆ›å»º Docker ç®¡ç†è„šæœ¬...${NC}"

# Docker å¯åŠ¨è„šæœ¬
cat > docker-start.sh <<'EOF'
#!/bin/bash
echo "å¯åŠ¨ LLM Chat System (Docker)..."
docker compose up -d
echo "æœåŠ¡å·²å¯åŠ¨"
docker compose ps
EOF

# Docker åœæ­¢è„šæœ¬
cat > docker-stop.sh <<'EOF'
#!/bin/bash
echo "åœæ­¢ LLM Chat System (Docker)..."
docker compose down
echo "æœåŠ¡å·²åœæ­¢"
EOF

# Docker é‡å¯è„šæœ¬
cat > docker-restart.sh <<'EOF'
#!/bin/bash
echo "é‡å¯ LLM Chat System (Docker)..."
docker compose restart
echo "æœåŠ¡å·²é‡å¯"
docker compose ps
EOF

# Docker çŠ¶æ€è„šæœ¬
cat > docker-status.sh <<'EOF'
#!/bin/bash
echo "LLM Chat System æœåŠ¡çŠ¶æ€ (Docker):"
echo "========================================="
docker compose ps
echo ""
echo "å®¹å™¨èµ„æºå ç”¨:"
docker stats --no-stream $(docker compose ps -q)
EOF

# Docker æ—¥å¿—è„šæœ¬
cat > docker-logs.sh <<'EOF'
#!/bin/bash
if [ -z "$1" ]; then
    echo "æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—..."
    docker compose logs -f
else
    echo "æŸ¥çœ‹ $1 æœåŠ¡æ—¥å¿—..."
    docker compose logs -f $1
fi
EOF

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x docker-start.sh docker-stop.sh docker-restart.sh docker-status.sh docker-logs.sh

echo -e "${GREEN}âœ“ ç®¡ç†è„šæœ¬å·²åˆ›å»º${NC}"

# å®Œæˆéƒ¨ç½²
echo ""
echo "========================================="
echo -e "${GREEN}  ðŸŽ‰ éƒ¨ç½²å®Œæˆ!${NC}"
echo "========================================="
echo ""

if [[ $ENABLE_NGINX =~ ^[Yy]$ ]]; then
    echo "è®¿é—®åœ°å€:"
    echo "  ${GREEN}ä¸»ç«™: http://$SERVER_HOST:$NGINX_PORT${NC}"
    echo "  åŽç«¯ç›´è¿ž: http://$SERVER_HOST:$BACKEND_PORT/docs"
else
    echo "è®¿é—®åœ°å€:"
    echo "  ${GREEN}å‰ç«¯: http://$SERVER_HOST:$FRONTEND_PORT${NC}"
    echo "  ${GREEN}åŽç«¯: http://$SERVER_HOST:$BACKEND_PORT/docs${NC}"
fi

echo ""
echo "Docker ç®¡ç†å‘½ä»¤:"
echo "  å¯åŠ¨æœåŠ¡: ${BLUE}./docker-start.sh${NC} æˆ– ${BLUE}docker compose up -d${NC}"
echo "  åœæ­¢æœåŠ¡: ${BLUE}./docker-stop.sh${NC} æˆ– ${BLUE}docker compose down${NC}"
echo "  é‡å¯æœåŠ¡: ${BLUE}./docker-restart.sh${NC} æˆ– ${BLUE}docker compose restart${NC}"
echo "  æŸ¥çœ‹çŠ¶æ€: ${BLUE}./docker-status.sh${NC} æˆ– ${BLUE}docker compose ps${NC}"
echo "  æŸ¥çœ‹æ—¥å¿—: ${BLUE}./docker-logs.sh${NC} æˆ– ${BLUE}docker compose logs -f${NC}"
echo "  æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—: ${BLUE}./docker-logs.sh backend${NC}"
echo ""
echo "å®¹å™¨ç®¡ç†:"
echo "  è¿›å…¥åŽç«¯å®¹å™¨: ${BLUE}docker compose exec backend bash${NC}"
echo "  è¿›å…¥å‰ç«¯å®¹å™¨: ${BLUE}docker compose exec frontend sh${NC}"
echo "  æŸ¥çœ‹èµ„æºå ç”¨: ${BLUE}docker stats${NC}"
echo ""
echo -e "${YELLOW}æ³¨æ„äº‹é¡¹:${NC}"
echo "1. æ•°æ®åº“æ–‡ä»¶: backend/conversation.db (å·²æŒ‚è½½åˆ°å®¿ä¸»æœº)"
echo "2. æ—¥å¿—æ–‡ä»¶: logs/ ç›®å½•ä¸‹"
echo "3. åœæ­¢å®¹å™¨ä¸ä¼šåˆ é™¤æ•°æ®ï¼Œä½¿ç”¨ 'docker compose down -v' ä¼šåˆ é™¤æ•°æ®å·"
echo "4. å®šæœŸå¤‡ä»½æ•°æ®åº“: cp backend/conversation.db backup/"

if [[ $ENABLE_NGINX =~ ^[Yy]$ ]]; then
    echo "5. Nginx é…ç½®æ–‡ä»¶: nginx/nginx-docker.conf"
fi

echo ""
echo -e "${GREEN}éƒ¨ç½²å®Œæˆï¼Œç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼${NC} ðŸš€"
echo ""
