# Bug修复记录 - 2025-10-09

## 🐛 问题描述

当后端或大模型服务没有响应或断开连接时，前端界面没有任何错误提示，用户只能看到持续的加载动画。

## 🔍 根本原因

在 `frontend/lib/api.ts` 的 `sendMessageStream` 函数中，存在一个**关键的错误处理bug**：

### 问题代码（第238-245行）

```typescript
// ❌ 错误的实现
try {
  const parsed = JSON.parse(data);

  if (parsed.error) {
    throw new Error(parsed.error);  // 抛出错误
  }
  // ... 其他逻辑
} catch (e) {
  // 忽略JSON解析错误
  continue;  // ❌ 这会忽略所有错误，包括我们刚抛出的错误！
}
```

**问题分析**：
- 当后端返回错误时（如 `{error: "无法连接到模型服务"}`），代码会抛出 `Error`
- 但是 catch 块会捕获这个错误，然后用 `continue` 跳过，导致错误被吞掉
- 外层的错误处理永远收不到这个错误
- 因此前端界面无法显示错误提示

## ✅ 解决方案

### 修复代码

```typescript
// ✅ 正确的实现
try {
  const parsed = JSON.parse(data);

  if (parsed.error) {
    console.error('[SSE ERROR]', parsed.error);
    throw new Error(parsed.error);
  }
  // ... 其他逻辑
} catch (e) {
  // 如果是我们抛出的错误，继续抛出
  if ((e as Error).message && !(e instanceof SyntaxError)) {
    throw e;  // ✅ 重新抛出，让外层catch捕获
  }
  // 只忽略JSON解析错误（SyntaxError）
  continue;
}
```

**修复说明**：
1. 检查错误类型：如果不是 `SyntaxError`（JSON解析错误），就重新抛出
2. 这样确保后端的错误信息能正确传递到外层的 catch 块
3. 外层catch块会更新UI，显示错误提示

## 🔧 其他改进

### 1. 添加超时机制

**总体请求超时**：60秒
```typescript
const requestTimeout = setTimeout(() => {
  abortController.abort();
}, 60000);
```

**数据接收超时**：15秒
```typescript
let dataTimeout: NodeJS.Timeout | undefined;
const resetDataTimeout = () => {
  if (dataTimeout) {
    clearTimeout(dataTimeout);
  }
  dataTimeout = setTimeout(() => {
    abortController.abort();
  }, 15000);
};
```

### 2. 改进错误信息

**超时错误**：
```
请求超时：大模型服务响应时间过长或网络连接中断，请检查模型服务状态或稍后重试
```

**后端错误**：
```
⚠️ 模型响应出错

抱歉，AI 模型在处理您的请求时遇到了问题。

错误信息： [具体错误信息]

可能的原因：
- 模型服务暂时不可用
- 网络连接问题
- 请求超时

建议：
- 请稍后重试
- 检查模型配置是否正确
- 如问题持续，请联系管理员
```

## 📊 错误处理流程

```
用户发送消息
    ↓
前端发起流式请求
    ↓
┌─────────────────────────────────┐
│  后端响应（SSE格式）              │
├─────────────────────────────────┤
│                                 │
│  正常：data: {"chunk": "..."}   │
│    → 显示内容 ✓                 │
│                                 │
│  错误：data: {"error": "..."}   │
│    → 抛出错误                   │
│    → 外层catch捕获              │
│    → 显示错误提示 ✓             │
│                                 │
│  超时：15秒无数据               │
│    → AbortController中止        │
│    → 抛出超时错误               │
│    → 显示超时提示 ✓             │
│                                 │
└─────────────────────────────────┘
```

## 🧪 测试验证

### 测试场景1：大模型服务不可用
**操作**：停止 CodeGeex/GLM 服务，发送消息

**预期结果**：
- ✅ 15秒内显示错误提示
- ✅ 错误信息：`无法连接到模型服务，请检查API地址和网络连接`

**实际结果**：✅ 通过

### 测试场景2：网络中断
**操作**：发送消息后断开网络

**预期结果**：
- ✅ 15秒内显示超时错误
- ✅ 错误信息：`请求超时：大模型服务响应时间过长或网络连接中断...`

**实际结果**：✅ 通过

### 测试场景3：正常响应
**操作**：大模型服务正常，发送消息

**预期结果**：
- ✅ 正常显示流式响应
- ✅ 不会触发超时

**实际结果**：✅ 通过

## 📝 修改的文件

1. **frontend/lib/api.ts**
   - 行 144-255：修复 `sendMessageStream` 函数的错误处理逻辑
   - 添加双重超时机制（60秒总体 + 15秒数据接收）
   - 改进错误检测和传递

2. **frontend/app/page.tsx**
   - 行 231-254：错误展示逻辑（已存在，正常工作）

## 🎯 关键要点

### Bug的本质
这是一个**错误被静默吞掉**的典型case：
- 代码抛出了错误 ✓
- 但错误在中途被捕获并忽略 ✗
- 导致错误无法到达UI层 ✗

### 修复的关键
**区分错误类型**：
- JSON解析错误（SyntaxError）→ 忽略（continue）
- 业务错误（我们抛出的Error）→ 重新抛出（throw）

### 经验教训
1. **不要盲目使用 `catch` 后 `continue`**：可能会吞掉重要的错误
2. **要区分可恢复的错误和不可恢复的错误**
3. **添加调试日志**：`console.error('[SSE ERROR]', ...)` 帮助排查
4. **测试错误场景**：不仅测试正常流程，也要测试异常流程

## 🚀 部署步骤

```bash
# 1. 重新构建
cd /home/data2/yangyk/llm-chat-v1/frontend
npm run build

# 2. 重启服务
pkill -9 -f "next-server"
nohup npm start > /tmp/frontend.log 2>&1 &

# 3. 验证服务
ps aux | grep "next-server"

# 4. 测试错误提示
# - 停止大模型服务
# - 发送消息
# - 应该在15秒内看到错误提示
```

## ✅ 验证清单

- [x] 代码修复完成
- [x] 构建成功
- [x] 服务重启
- [x] 大模型不可用时显示错误 ✓
- [x] 网络超时时显示错误 ✓
- [x] 正常情况下不受影响 ✓
- [x] 文档更新完成

## 📌 相关文档

- 详细技术文档：`docs/error-handling-improvement.md`
- 更新说明：`docs/UPDATE-2025-10-09.md`

---

**修复时间**: 2025-10-09
**修复人员**: AI Assistant
**问题级别**: 高（影响用户体验）
**修复状态**: ✅ 已完成并验证
